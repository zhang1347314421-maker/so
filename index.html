<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå…‰æ¼«å‰§ (Liuguang AI) - æ¡Œé¢ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      body { background-color: #0f172a; color: #f8fafc; margin: 0; overflow: hidden; user-select: none; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #1e293b; }
      ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
      .drag-active { border-color: #fbbf24 !important; background-color: rgba(251, 191, 36, 0.1) !important; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.32.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ERROR BOUNDARY (é˜²æ­¢ç™½å±) ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-screen w-full flex flex-col items-center justify-center bg-red-950 text-white p-10">
                            <h1 className="text-3xl font-bold mb-4">ç¨‹åºå‘ç”Ÿé”™è¯¯ (Crash)</h1>
                            <p className="mb-4 text-red-200">è¯·æˆªå›¾å‘ç»™å¼€å‘è€…ï¼š</p>
                            <pre className="bg-black/50 p-6 rounded border border-red-800 text-sm font-mono max-w-4xl overflow-auto w-full">
                                {this.state.error && this.state.error.toString()}
                            </pre>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="mt-8 bg-white text-red-900 px-6 py-2 rounded font-bold hover:bg-gray-200">
                                æ¸…é™¤ç¼“å­˜å¹¶é‡å¯ (å°è¯•ä¿®å¤)
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- ICONS ---
        const Icon = ({ name, className, ...props }) => {
            const iconRef = useRef(null);
            useEffect(() => { 
                if (window.lucide) window.lucide.createIcons({ root: iconRef.current, nameAttr: 'data-lucide-name', attrs: { class: className, ...props } }); 
            }, [name, className]);
            return <i ref={iconRef} data-lucide-name={name} className={className} {...props}></i>;
        };
        const Sparkles = p => <Icon name="sparkles" {...p} />;
        const BookOpen = p => <Icon name="book-open" {...p} />;
        const Settings = p => <Icon name="settings" {...p} />;
        const VideoIcon = p => <Icon name="video" {...p} />;
        const ImageIcon = p => <Icon name="image" {...p} />;
        const Loader2 = p => <Icon name="loader-2" {...p} />;
        const Trash2 = p => <Icon name="trash-2" {...p} />;
        const ArrowLeft = p => <Icon name="arrow-left" {...p} />;
        const Library = p => <Icon name="library" {...p} />;
        const ChevronDown = p => <Icon name="chevron-down" {...p} />;
        const ChevronRight = p => <Icon name="chevron-right" {...p} />;
        const Plus = p => <Icon name="plus" {...p} />;
        const User = p => <Icon name="user" {...p} />;
        const Check = p => <Icon name="check" {...p} />;
        const AlertCircle = p => <Icon name="alert-circle" {...p} />;

        // --- API SERVICES ---
        const callProxy = async (targetUrl, apiKey, body, method = 'POST') => {
            if (!targetUrl) throw new Error("API åœ°å€ä¸ºç©º");
            try {
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_url: targetUrl, api_key: apiKey, method, body })
                });
                
                if (!response.ok) throw new Error("æœ¬åœ°ä»£ç†æœåŠ¡å¼‚å¸¸");
                const result = await response.json();
                
                // æ£€æŸ¥æ˜¯å¦è¿”å›äº† HTML (URLé”™è¯¯å¸¸è§æƒ…å†µ)
                if (typeof result.data === 'string' && result.data.trim().startsWith('<')) {
                    throw new Error("API è¿”å›äº†ç½‘é¡µè€Œé JSONã€‚è¯·æ£€æŸ¥ URL æ˜¯å¦æ­£ç¡® (ä¸è¦å¡«å†™æ–‡æ¡£åœ°å€)");
                }

                if (!result.ok) {
                    const errMsg = result.data?.error?.message || result.data?.error || JSON.stringify(result.data) || "API è¯·æ±‚å¤±è´¥";
                    throw new Error(`å¤–éƒ¨ API æŠ¥é”™: ${errMsg}`);
                }
                return result.data;
            } catch (e) {
                console.error("Proxy Error", e);
                throw e;
            }
        };

        const cleanJsonString = (text) => {
            if (typeof text !== 'string') return text;
            let cleaned = text.trim();
            if (cleaned.startsWith('```json')) cleaned = cleaned.replace(/^```json\s*/, '').replace(/\s*```$/, '');
            else if (cleaned.startsWith('```')) cleaned = cleaned.replace(/^```\s*/, '').replace(/\s*```$/, '');
            return cleaned;
        };

        const analyzeScript = async (script, settings, libs) => {
            if (!settings.analysisApiUrl || !settings.analysisApiKey) throw new Error("è¯·é…ç½®åˆ†æ API");
            
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šå¯¼æ¼”ã€‚
            ä»»åŠ¡ï¼šå°†å‰§æœ¬æ‹†åˆ†ä¸ºçº¦15ä¸ªé•œå¤´ã€‚
            
            ã€æ ¸å¿ƒè®¾å®šåº“ã€‘
            1. å‰§æœ¬åˆ†æé£æ ¼: ${libs.script || "æ ‡å‡†å•†ä¸šç‰‡ç»“æ„"}
            2. ç”»é¢ç”Ÿæˆé£æ ¼(Visual): ${libs.image || "High Quality, 4k"}
            3. è§†é¢‘ç”Ÿæˆé£æ ¼(Video): ${libs.video || "Cinematic, Stable"}

            è¦æ±‚ï¼š
            - åˆ†æå‰§æƒ…ä¸­çš„å…³é”®è§’è‰²å’Œåœºæ™¯ï¼Œæå–ä¸º entitiesã€‚
            - å°†å‰§æœ¬æ‹†è§£ä¸º shots (10-15ä¸ª)ã€‚
            - ç¼–å†™ visualPrompt æ—¶ï¼Œå¿…é¡»èåˆä¸Šè¿°ã€ç”»é¢ç”Ÿæˆé£æ ¼ã€‘ã€‚
            - ç¼–å†™ videoPrompt æ—¶ï¼Œå¿…é¡»èåˆä¸Šè¿°ã€è§†é¢‘ç”Ÿæˆé£æ ¼ã€‘ã€‚
            
            è¯·è¿”å›çº¯ JSON (ä¸è¦ Markdown)ï¼ŒåŒ…å«:
            { "entities": [{"name": "...", "type": "CHARACTER/SCENE", "description": "..."}],
              "shots": [{"shotNumber": 1, "scriptSegment": "...", "visualPrompt": "è‹±æ–‡æç¤ºè¯...", "videoPrompt": "è‹±æ–‡è§†é¢‘æç¤ºè¯..."}] }
            `;

            const data = await callProxy(settings.analysisApiUrl, settings.analysisApiKey, {
                model: "gpt-4o", 
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: script}],
                temperature: 0.7
            });

            const content = data.choices?.[0]?.message?.content;
            if (!content) throw new Error("APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯ (ç¼ºå°‘ choices)");
            
            try {
                const parsed = JSON.parse(cleanJsonString(content));
                return {
                    entities: parsed.entities.map((e, i) => ({...e, id: `e-${Date.now()}-${i}`})),
                    shots: parsed.shots.map((s, i) => ({...s, id: `s-${Date.now()}-${i}`}))
                };
            } catch (e) {
                throw new Error("è§£æ AI è¿”å›çš„ JSON å¤±è´¥: " + content.substring(0, 100));
            }
        };

        const generateImage = async (prompt, settings) => {
            if (!settings.imageApiUrl || !settings.imageApiKey) throw new Error("è¯·é…ç½®å›¾ç‰‡ API");
            const data = await callProxy(settings.imageApiUrl, settings.imageApiKey, {
                prompt: prompt,
                aspect_ratio: "16:9",
                model: "flux-pro"
            });
            return data.url || data.data?.[0]?.url || data.image_url;
        };

        const generateVideo = async (prompt, refImg, settings) => {
            if (!settings.videoApiUrl || !settings.videoApiKey) throw new Error("è¯·é…ç½®è§†é¢‘ API");
            
            let body = { prompt: prompt, model: "luma-video", aspect_ratio: "16:9" };
            if (refImg) body.image_url = refImg;

            const taskData = await callProxy(settings.videoApiUrl, settings.videoApiKey, body);
            const taskId = taskData.task_id || taskData.id || taskData.data?.task_id;
            
            if (!taskId) throw new Error("åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼Œæœªè¿”å› Task ID");

            let queryUrl = settings.videoApiUrl;
            if (queryUrl.includes("create")) queryUrl = queryUrl.replace("create_task", "get_task").replace("create", "query");
            
            for (let i = 0; i < 20; i++) { 
                await new Promise(r => setTimeout(r, 3000));
                const qData = await callProxy(queryUrl, settings.videoApiKey, { task_id: taskId }, 'GET');
                const status = qData.status || qData.data?.status;
                if (status === 'success' || status === 'completed') return qData.video_url || qData.data?.video_url || qData.url;
                if (status === 'failed') throw new Error("è§†é¢‘ç”Ÿæˆä»»åŠ¡å¤±è´¥");
            }
            throw new Error("è§†é¢‘ç”Ÿæˆè¶…æ—¶");
        };

        // --- COMPONENTS ---

        const Dashboard = ({projects, onCreate, onSelect, onDelete}) => {
            const [name, setName] = useState('');
            return (
                <div className="p-10 max-w-5xl mx-auto h-screen overflow-y-auto">
                    <h1 className="text-4xl font-bold mb-2 text-indigo-400">æµå…‰æ¼«å‰§</h1>
                    <p className="text-slate-400 mb-10">AI é©±åŠ¨çš„æ¼«å‰§ä¸è§†é¢‘åˆ†é•œç”Ÿäº§å·¥å…·</p>
                    
                    <div className="flex gap-4 mb-10 items-end">
                        <div className="flex-1 max-w-md">
                            <label className="block text-xs text-slate-500 mb-1 uppercase font-bold tracking-wider">æ–°å»ºé¡¹ç›®</label>
                            <input value={name} onChange={e=>setName(e.target.value)} placeholder="è¾“å…¥å‰§é›†åç§° (ä¾‹å¦‚: ç¬¬ä¸€é›†)" className="w-full bg-slate-800 text-white px-4 py-3 rounded-l border border-slate-700 focus:border-indigo-500 outline-none transition-colors"/>
                        </div>
                        <button onClick={() => {if(name) onCreate(name)}} className="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-r font-bold transition-colors flex items-center gap-2">
                            <Plus className="w-5 h-5"/> åˆ›å»º
                        </button>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {projects.map(p => (
                            <div key={p.id} onClick={() => onSelect(p)} className="bg-slate-900/50 p-6 rounded-xl border border-slate-800 hover:border-indigo-500/50 hover:bg-slate-800 transition-all cursor-pointer relative group">
                                <h3 className="font-bold text-lg text-slate-200 mb-2">{p.name}</h3>
                                <div className="flex justify-between items-center mt-4">
                                    <span className="text-xs text-slate-500 bg-slate-950 px-2 py-1 rounded">{new Date(p.created).toLocaleDateString()}</span>
                                    <span className="text-xs text-slate-500">{p.shots?.length || 0} ä¸ªé•œå¤´</span>
                                </div>
                                <button onClick={(e)=>{e.stopPropagation(); onDelete(p.id)}} className="absolute top-4 right-4 text-slate-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                                    <Trash2 className="w-4 h-4"/>
                                </button>
                            </div>
                        ))}
                    </div>
                    {projects.length === 0 && (
                        <div className="text-center text-slate-600 py-20 border-2 border-dashed border-slate-800 rounded-xl">
                            <Library className="w-12 h-12 mx-auto mb-4 opacity-20"/>
                            <p>æš‚æ— é¡¹ç›®ï¼Œè¯·åœ¨ä¸Šæ–¹åˆ›å»º</p>
                        </div>
                    )}
                </div>
            )
        };

        const SettingsPanel = ({settings, onUpdate}) => {
            const [open, setOpen] = useState(false);
            const [testing, setTesting] = useState({}); // { key: boolean }
            const [status, setStatus] = useState({}); // { key: 'success' | 'error' | null }

            const handleTest = async (type) => {
                const keys = {
                    'ANALYSIS': { url: settings.analysisApiUrl, key: settings.analysisApiKey, body: { model: "gpt-3.5-turbo", messages: [{role:"user", content:"ping"}] } },
                    'IMAGE': { url: settings.imageApiUrl, key: settings.imageApiKey, body: { prompt: "test" } },
                    'VIDEO': { url: settings.videoApiUrl, key: settings.videoApiKey, body: { prompt: "test" } },
                };

                const config = keys[type];
                if (!config.url || !config.key) {
                    alert("è¯·å…ˆå¡«å†™ URL å’Œ Key");
                    return;
                }

                setTesting(p => ({...p, [type]: true}));
                setStatus(p => ({...p, [type]: null}));

                try {
                    await callProxy(config.url, config.key, config.body);
                    setStatus(p => ({...p, [type]: 'success'}));
                } catch (e) {
                    alert(`æµ‹è¯•å¤±è´¥: ${e.message}`);
                    setStatus(p => ({...p, [type]: 'error'}));
                } finally {
                    setTesting(p => ({...p, [type]: false}));
                }
            };

            const TestBtn = ({type}) => (
                <button 
                    onClick={() => handleTest(type)}
                    disabled={testing[type]}
                    className={`text-[10px] px-2 py-0.5 rounded ml-2 border transition-colors flex items-center gap-1
                        ${status[type] === 'success' ? 'bg-green-900/30 border-green-600 text-green-400' : 
                          status[type] === 'error' ? 'bg-red-900/30 border-red-600 text-red-400' : 
                          'bg-slate-800 border-slate-700 text-slate-400 hover:text-white'}`}
                >
                    {testing[type] ? <Loader2 className="w-3 h-3 animate-spin"/> : 
                     status[type] === 'success' ? <Check className="w-3 h-3"/> :
                     status[type] === 'error' ? <AlertCircle className="w-3 h-3"/> :
                     "æµ‹è¯•è¿æ¥"}
                </button>
            );

            return (
                <div className="relative z-50">
                    <button onClick={() => setOpen(!open)} className="text-xs bg-slate-800 border border-slate-700 hover:bg-slate-700 px-3 py-1.5 rounded flex items-center gap-2 text-slate-300 transition-colors">
                        <Settings className="w-3 h-3"/> API é…ç½®
                    </button>
                    {open && (
                        <>
                            <div className="fixed inset-0 bg-black/20 z-40" onClick={() => setOpen(false)}></div>
                            <div className="absolute right-0 top-12 w-96 bg-slate-900 border border-slate-700 p-5 rounded-lg shadow-2xl space-y-5 z-50">
                                <h3 className="font-bold text-sm text-white border-b border-slate-800 pb-2 flex justify-between items-center">
                                    æ¥å£è®¾ç½®
                                    <span className="text-[10px] text-slate-500 font-normal">ç‚¹å‡»å³ä¾§æŒ‰é’®æ£€æµ‹å¯ç”¨æ€§</span>
                                </h3>
                                <div>
                                    <label className="text-[10px] text-indigo-400 font-bold mb-1 flex items-center">
                                        å‰§æœ¬åˆ†æ (Comfly / é€šç”¨ LLM) <TestBtn type="ANALYSIS"/>
                                    </label>
                                    <input value={settings.analysisApiUrl || ''} onChange={e=>onUpdate('analysisApiUrl', e.target.value)} className="w-full bg-slate-950 text-xs p-2 rounded border border-slate-800 text-slate-300 mb-1 focus:border-indigo-500 outline-none"/>
                                    <input value={settings.analysisApiKey || ''} onChange={e=>onUpdate('analysisApiKey', e.target.value)} placeholder="Key (sk-...)" type="password" className="w-full bg-slate-950 text-xs p-2 rounded border border-slate-800 text-slate-300 focus:border-indigo-500 outline-none"/>
                                </div>
                                <div>
                                    <label className="text-[10px] text-pink-400 font-bold mb-1 flex items-center">
                                        å›¾ç‰‡ç”Ÿæˆ (Comfly / Flux) <TestBtn type="IMAGE"/>
                                    </label>
                                    <input value={settings.imageApiUrl || ''} onChange={e=>onUpdate('imageApiUrl', e.target.value)} className="w-full bg-slate-950 text-xs p-2 rounded border border-slate-800 text-slate-300 mb-1 focus:border-pink-500 outline-none"/>
                                    <input value={settings.imageApiKey || ''} onChange={e=>onUpdate('imageApiKey', e.target.value)} placeholder="Key" type="password" className="w-full bg-slate-950 text-xs p-2 rounded border border-slate-800 text-slate-300 focus:border-pink-500 outline-none"/>
                                </div>
                                <div>
                                    <label className="text-[10px] text-blue-400 font-bold mb-1 flex items-center">
                                        è§†é¢‘ç”Ÿæˆ (äº‘é›¾ Yunwu) <TestBtn type="VIDEO"/>
                                    </label>
                                    <input value={settings.videoApiUrl || ''} onChange={e=>onUpdate('videoApiUrl', e.target.value)} className="w-full bg-slate-950 text-xs p-2 rounded border border-slate-800 text-slate-300 mb-1 focus:border-blue-500 outline-none"/>
                                    <input value={settings.videoApiKey || ''} onChange={e=>onUpdate('videoApiKey', e.target.value)} placeholder="Key" type="password" className="w-full bg-slate-950 text-xs p-2 rounded border border-slate-800 text-slate-300 focus:border-blue-500 outline-none"/>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            )
        };

        const LibraryPanel = ({libs, onChange}) => {
            const [open, setOpen] = useState(true);
            const [dragTarget, setDragTarget] = useState(null);

            const handleDrop = (e, key) => {
                e.preventDefault();
                setDragTarget(null);
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => onChange(key, ev.target.result);
                    reader.readAsText(file);
                }
            };

            const InputArea = ({label, val, k, ph}) => (
                <div 
                    className={`relative group ${dragTarget === k ? 'drag-active' : ''}`}
                    onDragOver={e => { e.preventDefault(); setDragTarget(k); }}
                    onDragLeave={() => setDragTarget(null)}
                    onDrop={e => handleDrop(e, k)}
                >
                    <div className="flex justify-between items-center mb-1">
                        <label className="text-[10px] text-slate-400">{label}</label>
                        <span className="text-[9px] text-slate-600 group-hover:text-indigo-400 transition-colors">æ”¯æŒæ‹–å…¥ .txt</span>
                    </div>
                    <textarea value={val || ''} onChange={e=>onChange(k, e.target.value)} placeholder={ph} className="w-full text-[10px] bg-slate-800 p-2 rounded border border-slate-700 focus:border-indigo-500 outline-none resize-none h-16 transition-all"/>
                </div>
            );

            return (
                <div className="mb-4 bg-slate-800/30 rounded-lg border border-slate-800/50 overflow-hidden">
                    <button onClick={()=>setOpen(!open)} className="w-full flex justify-between text-xs font-bold text-amber-400 p-3 bg-slate-800/50 hover:bg-slate-800 transition-colors items-center">
                        <span className="flex gap-2 items-center"><Library className="w-3 h-3"/> ğŸ“š æ ¸å¿ƒè®¾å®šåº“</span> 
                        {open?<ChevronDown className="w-3 h-3"/>:<ChevronRight className="w-3 h-3"/>}
                    </button>
                    {open && (
                        <div className="p-3 space-y-3">
                            <InputArea label="å‰§æœ¬é£æ ¼è®¾å®š" val={libs?.script} k="script" ph="ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹é£æ ¼ï¼Œå¼ºè°ƒå¿ƒç†æå†™..."/>
                            <InputArea label="ç”»é¢é€šç”¨æç¤ºè¯ (Visual)" val={libs?.image} k="image" ph="ä¾‹å¦‚ï¼šGhibli style, vibrant colors..."/>
                            <InputArea label="è§†é¢‘é€šç”¨æç¤ºè¯ (Video)" val={libs?.video} k="video" ph="ä¾‹å¦‚ï¼š4k, slow motion, cinematic lighting..."/>
                        </div>
                    )}
                </div>
            )
        };

        const EntitiesPanel = ({entities, onChange}) => {
            const refInput = useRef(null);
            const curId = useRef(null);
            
            const handleUpload = (e) => {
                const f = e.target.files[0];
                if(f && curId.current) {
                    const r = new FileReader();
                    r.onload = () => onChange(entities.map(en => en.id===curId.current ? {...en, referenceImage: r.result} : en));
                    r.readAsDataURL(f);
                }
            };

            return (
                <div className="flex-1 flex flex-col min-h-0">
                    <h3 className="text-xs font-bold text-slate-400 mb-2 flex items-center gap-2"><User className="w-3 h-3"/> å…ƒç´ /è§’è‰²åº“</h3>
                    <input type="file" ref={refInput} className="hidden" accept="image/*" onChange={handleUpload}/>
                    <div className="overflow-y-auto flex-1 pr-1 space-y-2">
                        {(!entities || entities.length === 0) && <div className="text-[10px] text-slate-600 text-center py-4">åˆ†æå‰§æœ¬åè‡ªåŠ¨ç”Ÿæˆ</div>}
                        {entities && entities.map(e => (
                            <div key={e.id} className="bg-slate-800 p-2 rounded border border-slate-700 hover:border-slate-600 transition-colors">
                                <div className="flex justify-between text-xs font-bold mb-2">
                                    <span className="text-slate-200">{e.name}</span>
                                    <span className="text-[10px] px-1.5 py-0.5 bg-slate-700 rounded text-slate-400">{e.type}</span>
                                </div>
                                <div className="flex gap-2">
                                    <div onClick={()=>{curId.current=e.id; refInput.current.click()}} className="w-16 h-16 bg-black/40 rounded border border-dashed border-slate-600 flex-shrink-0 flex items-center justify-center cursor-pointer hover:border-indigo-500 transition-colors overflow-hidden group relative">
                                        {e.referenceImage ? <img src={e.referenceImage} className="w-full h-full object-contain"/> : <span className="text-[9px] text-slate-500 group-hover:text-indigo-400">ä¸Šä¼ </span>}
                                    </div>
                                    <textarea value={e.description || ''} onChange={ev=>onChange(entities.map(en=>en.id===e.id?{...en, description: ev.target.value}:en))} className="flex-1 text-[10px] bg-slate-900 border border-slate-700 rounded p-1.5 focus:border-indigo-500 outline-none resize-none text-slate-300" placeholder="å…ƒç´ æè¿°..."/>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        const ShotCard = ({shot, entities, onGenImg, onGenVideo, onUpdate}) => {
            const findScene = (txt) => {
                if (!txt || !entities) return null;
                return entities.find(e => e.type === 'SCENE' && e.referenceImage && txt.includes(e.name))?.referenceImage;
            };
            
            return (
                <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden flex flex-col hover:border-slate-700 transition-all shadow-lg">
                    <div className="p-3 border-b border-slate-800 flex justify-between bg-slate-900/80">
                        <span className="text-xs font-bold text-indigo-400">Shot #{shot.shotNumber}</span>
                        <div className="flex gap-2">
                           <span className="w-2 h-2 rounded-full bg-slate-700"></span>
                        </div>
                    </div>
                    <div className="p-4 flex-1 flex flex-col gap-4">
                        <p className="text-sm text-slate-300 italic border-l-2 border-indigo-500/50 pl-3 py-1 bg-slate-800/30 rounded-r">
                            {shot.scriptSegment || "..."}
                        </p>
                        
                        <div className="bg-black/30 p-2 rounded border border-slate-800/50 group focus-within:border-indigo-500/50 transition-colors">
                            <label className="text-[9px] text-slate-500 block mb-1 uppercase font-bold">Visual Prompt</label>
                            <textarea value={shot.visualPrompt || ''} onChange={e=>onUpdate({visualPrompt: e.target.value})} className="w-full bg-transparent text-xs text-slate-300 outline-none resize-none h-12" placeholder="ç”Ÿæˆå‰å¯ç¼–è¾‘..."/>
                        </div>

                        {/* Media Display Area */}
                        <div className="grid grid-cols-2 gap-3 h-48">
                            {/* Image Slot */}
                            <div className="bg-black rounded-lg border border-slate-800 relative overflow-hidden flex items-center justify-center group">
                                {shot.imgUrl ? 
                                    <img src={shot.imgUrl} className="w-full h-full object-contain bg-black"/> : 
                                    shot.loadingImg ? <Loader2 className="animate-spin text-pink-500 w-8 h-8"/> : 
                                    <div className="flex flex-col items-center gap-2 text-slate-700"><ImageIcon className="w-8 h-8"/><span className="text-[10px]">Empty</span></div>
                                }
                                <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center backdrop-blur-sm">
                                    <button onClick={()=>onGenImg(shot.visualPrompt)} disabled={shot.loadingImg} className="bg-pink-600 hover:bg-pink-500 text-white text-xs font-bold px-4 py-2 rounded-full shadow-lg transform translate-y-2 group-hover:translate-y-0 transition-all">
                                        {shot.imgUrl ? 'é‡æ–°ç”Ÿæˆ' : 'ç”Ÿæˆåˆ†é•œå›¾'}
                                    </button>
                                </div>
                            </div>
                            
                            {/* Video Slot */}
                            <div className="bg-black rounded-lg border border-slate-800 relative overflow-hidden flex items-center justify-center group">
                                {shot.videoUrl ? 
                                    <video src={shot.videoUrl} controls className="w-full h-full object-contain bg-black"/> : 
                                    shot.loadingVideo ? <Loader2 className="animate-spin text-blue-500 w-8 h-8"/> : 
                                    <div className="flex flex-col items-center gap-2 text-slate-700"><VideoIcon className="w-8 h-8"/><span className="text-[10px]">Empty</span></div>
                                }
                                <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center backdrop-blur-sm">
                                    <button onClick={()=>onGenVideo(shot.videoPrompt, findScene(shot.scriptSegment))} disabled={shot.loadingVideo} className="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-4 py-2 rounded-full shadow-lg transform translate-y-2 group-hover:translate-y-0 transition-all">
                                        {shot.videoUrl ? 'é‡æ–°ç”Ÿæˆ' : 'ç”Ÿæˆè§†é¢‘'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [settings, setSettings] = useState({
                analysisApiUrl: 'https://api.openai.com/v1/chat/completions', 
                analysisApiKey: '',
                imageApiUrl: 'https://api.comfly.chat/v1/images/generations',
                imageApiKey: '',
                videoApiUrl: 'https://api.yunwu.ai/v1/video/create_task',
                videoApiKey: ''
            });
            
            useEffect(() => {
                const saved = localStorage.getItem('lg_settings');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        // Merge with defaults to prevent missing keys causing uncontrolled inputs
                        setSettings(s => ({...s, ...parsed}));
                    } catch(e) {}
                }
            }, []);
            
            const updateSetting = (k, v) => {
                const newS = {...settings, [k]: v};
                setSettings(newS);
                localStorage.setItem('lg_settings', JSON.stringify(newS));
            };

            const [view, setView] = useState('DASHBOARD');
            const [projects, setProjects] = useState(() => {
                try { return JSON.parse(localStorage.getItem('lg_projects') || '[]'); } catch(e) { return []; }
            });
            const [curProjId, setCurProjId] = useState(null);
            
            useEffect(() => localStorage.setItem('lg_projects', JSON.stringify(projects)), [projects]);

            const curProj = useMemo(() => projects.find(p => p.id === curProjId), [projects, curProjId]);

            const updateProj = (data) => {
                if (!curProjId) return;
                setProjects(prev => prev.map(p => p.id === curProjId ? {...p, ...data} : p));
            };

            // Handlers
            const handleCreate = (name) => {
                const newP = {
                    id: Date.now(), 
                    name, 
                    created: Date.now(), 
                    libraries: {script:'', image:'', video:''}, 
                    entities: [], 
                    shots: []
                };
                setProjects(prev => [newP, ...prev]);
                setCurProjId(newP.id);
                setTimeout(() => setView('EDITOR'), 50); 
            };

            const doAnalyze = async (txt) => {
                if(!txt.trim()) return alert("è¯·è¾“å…¥å‰§æœ¬");
                updateProj({isAnalyzing: true});
                try {
                    const res = await analyzeScript(txt, settings, curProj.libraries || {});
                    updateProj({script: txt, entities: res.entities, shots: res.shots, isAnalyzing: false});
                } catch(e) { 
                    alert(e.message); 
                    updateProj({isAnalyzing: false}); 
                }
            };

            const doGenImg = async (shotId, prompt) => {
                const newShots = curProj.shots.map(s => s.id === shotId ? {...s, loadingImg: true} : s);
                updateProj({shots: newShots});
                try {
                    const url = await generateImage(prompt, settings);
                    updateProj({shots: curProj.shots.map(s => s.id === shotId ? {...s, loadingImg: false, imgUrl: url} : s)});
                } catch(e) { 
                    alert(e.message); 
                    updateProj({shots: curProj.shots.map(s => s.id === shotId ? {...s, loadingImg: false} : s)}); 
                }
            };

            const doGenVideo = async (shotId, prompt, refImg) => {
                const newShots = curProj.shots.map(s => s.id === shotId ? {...s, loadingVideo: true} : s);
                updateProj({shots: newShots});
                try {
                    const url = await generateVideo(prompt, refImg, settings);
                    updateProj({shots: curProj.shots.map(s => s.id === shotId ? {...s, loadingVideo: false, videoUrl: url} : s)});
                } catch(e) { 
                    alert(e.message); 
                    updateProj({shots: curProj.shots.map(s => s.id === shotId ? {...s, loadingVideo: false} : s)}); 
                }
            };

            // Render
            if (view === 'DASHBOARD') {
                return <Dashboard 
                    projects={projects} 
                    onCreate={handleCreate}
                    onSelect={p => {setCurProjId(p.id); setView('EDITOR');}}
                    onDelete={id => setProjects(prev => prev.filter(p => p.id !== id))}
                />;
            }

            if (!curProj) return <div className="h-screen flex items-center justify-center text-slate-500 bg-slate-950"><Loader2 className="animate-spin w-8 h-8"/></div>;

            return (
                <div className="h-screen flex flex-col bg-slate-950 text-white">
                    {/* Header */}
                    <div className="h-14 border-b border-slate-800 flex items-center px-6 gap-4 bg-slate-900 shadow-sm z-10">
                        <button onClick={() => setView('DASHBOARD')} className="text-slate-400 hover:text-white flex items-center gap-1 text-xs font-bold transition-colors">
                            <ArrowLeft className="w-4 h-4"/> é¡¹ç›®åˆ—è¡¨
                        </button>
                        <div className="h-4 w-[1px] bg-slate-700"></div>
                        <span className="text-sm font-bold text-white tracking-wide">{curProj.name}</span>
                        <div className="flex-1"></div>
                        <SettingsPanel settings={settings} onUpdate={updateSetting} />
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex overflow-hidden">
                        {/* Left: Script */}
                        <div className="w-[320px] border-r border-slate-800 bg-slate-900/50 flex flex-col p-4">
                            <h3 className="text-xs font-bold text-slate-400 mb-3 flex gap-2 items-center uppercase tracking-wider"><BookOpen className="w-4 h-4 text-indigo-500"/> å‰§æœ¬è¾“å…¥</h3>
                            <textarea 
                                className="flex-1 bg-slate-800 p-3 rounded-lg text-sm text-slate-200 resize-none border border-slate-700 focus:border-indigo-500 outline-none leading-relaxed" 
                                placeholder="åœ¨æ­¤å¤„ç²˜è´´æ‚¨çš„å‰§æœ¬..." 
                                value={curProj.script || ''} 
                                onChange={e => updateProj({script: e.target.value})} 
                            />
                            <button 
                                onClick={() => doAnalyze(curProj.script)} 
                                disabled={curProj.isAnalyzing || !curProj.script} 
                                className="mt-3 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 disabled:opacity-50 disabled:cursor-not-allowed py-3 rounded-lg font-bold text-sm flex justify-center items-center gap-2 shadow-lg transition-all"
                            >
                                {curProj.isAnalyzing ? <><Loader2 className="animate-spin w-4 h-4"/> AI åˆ†æä¸­...</> : <><Sparkles className="w-4 h-4"/> å¼€å§‹åˆ†æå‰§æœ¬</>}
                            </button>
                        </div>

                        {/* Middle: Library & Entities */}
                        <div className="w-[300px] border-r border-slate-800 bg-slate-900/30 flex flex-col p-4 overflow-hidden">
                            <div className="flex-shrink-0">
                                <LibraryPanel libs={curProj.libraries || {script:'', image:'', video:''}} onChange={(k,v) => updateProj({libraries: {...(curProj.libraries||{}), [k]: v}})} />
                                <div className="h-[1px] bg-slate-800 my-4"></div>
                            </div>
                            <EntitiesPanel entities={curProj.entities || []} onChange={newEs => updateProj({entities: newEs})} />
                        </div>

                        {/* Right: Shots Feed */}
                        <div className="flex-1 bg-slate-950 p-8 overflow-y-auto scroll-smooth">
                            {(!curProj.shots || curProj.shots.length === 0) ? (
                                <div className="h-full flex flex-col items-center justify-center text-slate-700 space-y-4">
                                    <div className="w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center">
                                        <VideoIcon className="w-10 h-10 opacity-20"/>
                                    </div>
                                    <p>è¯·åœ¨å·¦ä¾§è¾“å…¥å‰§æœ¬å¹¶ç‚¹å‡»åˆ†æ</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20 max-w-7xl mx-auto">
                                    {curProj.shots.map(shot => (
                                        <ShotCard key={shot.id} shot={shot} 
                                            entities={curProj.entities || []}
                                            onGenImg={p => doGenImg(shot.id, p)}
                                            onGenVideo={(p, ref) => doGenVideo(shot.id, p, ref)}
                                            onUpdate={newS => updateProj({shots: curProj.shots.map(s => s.id === shot.id ? {...s, ...newS} : s)})}
                                        />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>